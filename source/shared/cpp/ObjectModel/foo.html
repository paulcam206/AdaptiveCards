<!doctype html>
<html lang="en-us">
  <head>
    <script async type="text/javascript" src="ObjectModel.js"></script>
    <script type="text/javascript">

      var Module = {
        onRuntimeInitialized: function() {
          let myCustomElement = Module.baseCardElement.extend("baseCardElement", {
            __construct: function() {
              this.__parent.__construct.call(this);
            },
            setId: function(str) {
              Module.baseElement.prototype.setId.call(this, `JS? '${str}'`);
            },
            getId: function() {
              return Module.baseElement.prototype.getId.call(this);
            },
            toString: function() {
              const baseSerialize = Module.baseElement.prototype.toString.call(this);
              let baseObj = JSON.parse(baseSerialize);
              baseObj["customProperty"] = this.customProperty;
              baseObj["type"] = this.getElementType();
              return JSON.stringify(baseObj);
            },
            getElementType: function() {
              return "MyCustomElement";
            },
            customProperty: 8
          });

          let derivedInstance = new myCustomElement();
          console.log(derivedInstance.toString());

          let customParser = Module.baseCardElementParser.extend("baseCardElementParser", {
            __construct: function() {
              this.__parent.__construct.call(this);
            },
            deserialize: function(ctx, jsonObj) {
              let retval = new myCustomElement();
              retval.deserializeBaseProperties(ctx, jsonObj);
              let customProp = jsonObj.get("customProperty", new Module.jsonValue());
              if (customProp?.isInt())
              {
                retval.customProperty = customProp.asInt();
              }

              return retval;
            },
            deserializeFromString: function(ctx, jsonStr) {
              let customElem = new myCustomElement();
              customElem.deserializeBasePropertiesFromString(ctx, jsonStr);

              let jsonObj = JSON.parse(jsonStr);
              if (jsonObj["customProperty"]) {
                customElem.customProperty = jsonObj["customProperty"];
              }
              return customElem;
            }
          });

          let parseContext = new Module.parseContext();
          let registration = parseContext.elementParserRegistration;
          let customParserPreInsert = new customParser();
          registration.addParser("MyCustomElement", customParserPreInsert);

          let customParseInstance = parseContext.elementParserRegistration.getParser("MyCustomElement");

          let customStr = `{ "type": "MyCustomElement", "id": "steve", "customProperty": 1 }`;
          console.log(`about to parse: "${customStr}" (non-inserted parser)`);
          let preinsertObj = customParserPreInsert.deserializeFromString(parseContext, customStr);
          console.log(`\ttype: ${preinsertObj.getElementType()}\n\tid: ${preinsertObj.getId()}\n\tcustomprop: ${preinsertObj.customProperty}`);

          console.log(`about to parse: "${customStr}" (inserted parser)`);
          let customObj = customParseInstance.deserializeFromString(parseContext, customStr);
          console.log(`\ttype: ${customObj.getElementType()}\n\tid: ${customObj.getId()}\n\tcustomprop: ${customObj.customProperty}`);

          const containerParser = registration.getParser("Container");
          const containerString = JSON.stringify(
            {
              "type": "Container",
              "items": [
                {
                  "type": "TextBlock",
                  "text": "are you kidding me?"
                },
                {
                  "type": "MyCustomElement",
                  "id": "whaaaaaaaaat",
                  "customProperty": 42
                }
              ]
            });

          const parsedContainer = containerParser.deserializeFromString(parseContext, containerString);

          const items = parsedContainer.getItems();
          for (let i = 0; i < items.size(); i++)
          {
            console.log(`item ${i}: "${items.get(i).toString()}"`);
          }

          let myCard = JSON.stringify({
            "$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
            "type": "AdaptiveCard",
            "version": "1.5",
            "body": [
              {
                "type": "TextBlock",
                "text": "an actual card!"
              },
              {
                "type": "Container",
                "items": [
                  {
                    "type": "TextBlock",
                    "text": "this is ridiculous"
                  },
                  {
                    "type": "MyCustomElement",
                    "id": "bleh",
                    "customProperty": 1024
                  }
                ]
              }
            ]
          });

          let parseResult = Module.adaptiveCard.fromString(myCard, "1.5");
          console.log(`roundtripped as "${parseResult.card.toString()}"`);
        }
      };
    </script>
  </head>
  <body>
  </body>
</html>
